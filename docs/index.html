<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>1365 모집 현황</title>
  <style>
    :root { --fg:#1f2328; --muted:#57606a; --line:#d0d7de; --bg:#fff; --accent:#0969da;}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Apple SD Gothic Neo,Noto Sans KR,sans-serif;margin:0;color:var(--fg);background:var(--bg);}
    header{padding:16px 20px;border-bottom:1px solid var(--line)}
    header h1{font-size:20px;margin:0 0 8px}
    .meta{font-size:12px;color:var(--muted)}
    main{padding:16px 20px}
    .toolbar{display:grid;gap:10px;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));margin:0 0 12px}
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 4px}
    input[type="date"],input[type="number"],input[type="text"]{width:100%;box-sizing:border-box;padding:8px 10px;border:1px solid var(--line);border-radius:8px;font-size:14px}
    .btns{display:flex;gap:8px;align-items:end}
    button{border:1px solid var(--line);background:#f6f8fa;padding:9px 14px;border-radius:10px;font-size:14px;cursor:pointer}
    button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    table{width:100%;border-collapse:collapse;border:1px solid var(--line)}
    thead th{position:sticky;top:0;background:#f6f8fa;border-bottom:1px solid var(--line);padding:10px 8px;text-align:left;font-size:13px}
    tbody td{border-top:1px solid var(--line);padding:9px 8px;font-size:13px;vertical-align:top}
    tbody tr:hover{background:#fffdf7}
    .num{text-align:right;width:80px}
    .nowrap{white-space:nowrap}
    .muted{color:var(--muted)}
    .link{color:var(--accent);text-decoration:none}
    .link:hover{text-decoration:underline}
    .error{color:#b42318;background:#ffefef;border:1px solid #ffcccc;padding:10px;border-radius:8px;margin:10px 0}
    .chips{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 14px}
    .chip{border:1px solid var(--line);border-radius:999px;padding:3px 8px;font-size:12px;background:#fff}
    .foot{margin:14px 0 0;font-size:12px;color:var(--muted)}
    @media (max-width:760px){ .hide-sm{display:none} }
  </style>
</head>
<body>
  <header>
    <h1>1365 모집 현황</h1>
    <div class="meta">
      마지막 업데이트: <span id="last-updated">-</span>
      · 총 수집: <span id="total-count">0</span>건
      · 현재 표시: <span id="shown-count">0</span>건
      · <a class="link" href="data/1365.json" target="_blank" rel="noopener">원본 JSON</a>
    </div>
    <div id="load-error" class="error" style="display:none"></div>
  </header>

  <main>
    <div class="toolbar">
      <div>
        <label>봉사기간 (시작)</label>
        <input type="date" id="f-from" />
      </div>
      <div>
        <label>봉사기간 (종료)</label>
        <input type="date" id="f-to" />
      </div>
      <div>
        <label>키워드 (제목/기관/장소)</label>
        <input type="text" id="f-keyword" placeholder="예: 환경, 청소년, 독거…" />
      </div>
      <div>
        <label>모집인원 (이상)</label>
        <input type="number" id="f-min" placeholder="0" min="0" step="1" />
      </div>
      <div>
        <label>봉사지역 (키워드)</label>
        <input type="text" id="f-region" placeholder="예: 강남, 은평, 서울…" />
      </div>
      <div class="btns">
        <button class="primary" id="btn-search">검색</button>
        <button id="btn-reset">초기화</button>
      </div>
    </div>

    <div id="chips" class="chips"></div>

    <table>
      <thead>
        <tr>
          <th class="nowrap">프로그램번호</th>
          <th>제목</th>
          <th class="nowrap hide-sm">모집기간</th>
          <th class="nowrap">봉사기간</th>
          <th class="num">모집인원</th>
          <th class="hide-sm">모집기관</th>
          <th class="hide-sm">등록기관</th>
          <th>장소/지역</th>
        </tr>
      </thead>
      <tbody id="table-body">
        <tr><td colspan="8" class="muted" style="text-align:center">로딩 중…</td></tr>
      </tbody>
    </table>

    <p class="foot">
      * 모집인원은 목록 API에 없을 경우 상세페이지에서 보강 수집됩니다. 일부 항목은 빈 값일 수 있어요.
    </p>
  </main>

  <script>
    const strip = s => (s||'').toString().trim();
    const toYmd = s => strip(s).replaceAll('-', '');
    const fmtDate = y8 => (typeof y8 === 'string' && y8.length===8) ? `${y8.slice(0,4)}-${y8.slice(4,6)}-${y8.slice(6,8)}` : (y8||'');
    const overlap = (aStart, aEnd, bStart, bEnd) => {
      if (bStart && aEnd && aEnd < bStart) return false;
      if (bEnd && aStart && aStart > bEnd) return false;
      return true;
    };
    const esc = s => (s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

    let ALL = [];

    async function loadJson() {
      const base = location.pathname.endsWith('/') ? location.pathname
        : location.pathname.replace(/\/[^\/]*$/, '/');
      const url = new URL('data/1365.json?v=' + Date.now(), location.origin + base).toString();

      try {
        const res = await fetch(url, { cache: 'no-store' });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();

        document.getElementById('last-updated').textContent = data?.updatedAt || '';
        document.getElementById('total-count').textContent = data?.count ?? 0;
        ALL = Array.isArray(data?.items) ? data.items : [];
        render(ALL);
      } catch (e) {
        console.error('JSON 로드 실패', e);
        const box = document.getElementById('load-error');
        box.style.display = 'block';
        box.textContent = '데이터를 불러오지 못했습니다: ' + (e.message || e);
        document.getElementById('table-body').innerHTML =
          `<tr><td colspan="8" class="muted" style="text-align:center">데이터 로드 실패</td></tr>`;
      }
    }

    function getFilters() {
      return {
        from: toYmd(document.getElementById('f-from').value),
        to:   toYmd(document.getElementById('f-to').value),
        kw:   strip(document.getElementById('f-keyword').value).toLowerCase(),
        min:  Number(document.getElementById('f-min').value || 0),
        region: strip(document.getElementById('f-region').value).toLowerCase()
      };
    }

    function applyFilter(rows, f) {
      return rows.filter(r => {
        const sj = strip(r.progrmSj).toLowerCase();
        const org1 = strip(r.mnnstNm).toLowerCase();
        const org2 = strip(r.nanmmbyNm).toLowerCase();
        const place = strip(r.actPlace).toLowerCase();
        const nb = strip(r.progrmBgnde), ne = strip(r.progrmEndde);
        const rn = Number(r.rcritNmpr || 0);

        const okKw = !f.kw || (sj.includes(f.kw) || org1.includes(f.kw) || org2.includes(f.kw) || place.includes(f.kw));
        const okRegion = !f.region || (place.includes(f.region) || org1.includes(f.region) || org2.includes(f.region));
        const okMin = rn >= f.min;
        const okPeriod = overlap(nb, ne, f.from, f.to);

        return okKw && okRegion && okMin && okPeriod;
      });
    }

    function render(rows) {
      document.getElementById('shown-count').textContent = rows.length;

      const f = getFilters();
      document.getElementById('chips').innerHTML = [
        (f.from || f.to) ? `<span class="chip">기간: ${f.from||'~'} ~ ${f.to||'~'}</span>` : '',
        f.kw ? `<span class="chip">키워드: ${esc(f.kw)}</span>` : '',
        f.min ? `<span class="chip">모집인원≥ ${f.min}</span>` : '',
        f.region ? `<span class="chip">지역: ${esc(f.region)}</span>` : '',
      ].filter(Boolean).join('');

      const tbody = document.getElementById('table-body');
      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="8" class="muted" style="text-align:center">표시할 데이터가 없습니다.</td></tr>`;
        return;
      }

      tbody.innerHTML = rows.map(r => {
        const pid = r.progrmRegistNo;
        const link = `https://www.1365.go.kr/vols/P9210/partcptn/timeCptn.do?type=show&progrmRegistNo=${encodeURIComponent(pid)}`;
        return `
          <tr>
            <td class="nowrap">${pid}</td>
            <td><a class="link" href="${link}" target="_blank" rel="noopener">${esc(r.progrmSj || '')}</a></td>
            <td class="nowrap hide-sm">${fmtDate(r.noticeBgnde)} ~ ${fmtDate(r.noticeEndde)}</td>
            <td class="nowrap">${fmtDate(r.progrmBgnde)} ~ ${fmtDate(r.progrmEndde)}</td>
            <td class="num">${Number(r.rcritNmpr || 0)}</td>
            <td class="hide-sm">${esc(r.mnnstNm || '')}</td>
            <td class="hide-sm">${esc(r.nanmmbyNm || '')}</td>
            <td>${esc(r.actPlace || '')}</td>
          </tr>
        `;
      }).join('');
    }

    document.getElementById('btn-search').addEventListener('click', () => {
      render(applyFilter(ALL, getFilters()));
    });
    document.getElementById('btn-reset').addEventListener('click', () => {
      document.getElementById('f-from').value = '';
      document.getElementById('f-to').value = '';
      document.getElementById('f-keyword').value = '';
      document.getElementById('f-min').value = '';
      document.getElementById('f-region').value = '';
      render(ALL);
    });
    document.getElementById('f-keyword').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { e.preventDefault(); render(applyFilter(ALL, getFilters())); }
    });

    loadJson();
  </script>
</body>
</html>
